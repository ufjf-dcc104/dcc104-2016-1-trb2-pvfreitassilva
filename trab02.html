<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Shooter car</title>
		<style>
			body{
				margin: 20px;
			}
		</style>
		<script src="AudioResources.js"></script>
		<script src="Constantes.js"></script>
		<script src="Sprite.js"></script>
		<script src="Cenario.js"></script>
		<script src="Inimigos.js"></script>
		<script src="Mouse.js"></script>
		<script src="Teclado.js"></script>
		<script src="Informacoes.js"></script>
		<script src="Minimapa.js"></script>
	</head>
	<body>
	<canvas>
		Seu navegador n√£o tem suporte ao canvas!
		Atualize seu navegador.
	</canvas>
	<script>
		var canvas = document.getElementsByTagName("canvas")[0];
		var ctx = canvas.getContext("2d");
		canvas.width = 800;//window.innerWidth-40;
		canvas.height = 600;//window.innerHeight-50;
		
		var excluirTiros = [];
		var excluirInimigos = [];
		var inimigos = [];
		var tiros = [];
				
		var pc = new Sprite();
		pc.danificado = 0;
		pc.col = 0;
		pc.raio = pcraio;
		pc.raioCanhao = pcraiocanhao;
		pc.animacaoCanhao = 0;
		pc.animarCanhao = false;
		pc.y = canvas.height/2;
		pc.x = pcxinicial;
		pc.img = carro;
		pc.vidas = maxVidas;

		function passo(){

			if(inimigos.length == 0){
				insereInimigos();
			}

			pc.mover();
			for (var i in inimigos) {
				inimigos[i].mover();
			}
			for (var i in tiros) {
				tiros[i].mover();
			}
			for(var i in cenario.pedras){
				cenario.pedras[i].mover();
			}

			pc.restricoes();
			for (var i in inimigos) {
				inimigos[i].restricoes();
			}
			for (var i in tiros) {
				tiros[i].restricoes();
			}

			//Limpar a tela
 			ctx.clearRect(0,0, canvas.width, canvas.height);
			
			cenario.restricoes();
			cenario.desenhar();
			desenhaInfos();
			desenhaMinimapa();

			for (var i in tiros) {
				tiros[i].desenhar();
			}

			for (var i in inimigos) {
				inimigos[i].desenhar();
			}

			if(pc.saude>0 || pc.linExplosao<4){
				pc.desenhar();
			}

			for(var i in tiros){
				if(tiros[i].foraDaTela())
					excluirTiros.push(tiros[i])
			}
			
			for (var i in inimigos) {
				for(var j in tiros){
					if(	inimigos[i].danificado <= 0
						&& tiros[j].colidiuComCircular(inimigos[i])
						&& !tiros[j].deInimigo){
						inimigos[i].danificado = tempoDanificado;
						inimigos[i].saude-= tiros[j].forca;
						excluirTiros.push(tiros[j]);
					}
				}
				if(inimigos[i].saude <=0 && inimigos[i].x < 0){
					excluirInimigos.push(inimigos[i]);
					inimigosDerrotados++;
				}
			}

			for(var i in tiros){
				if(	pc.danificado <= 0
					&& tiros[i].colidiuComCircular(pc)
					&& tiros[i].deInimigo){
					pc.danificado = tempoDanificado;
					pc.saude-= tiros[j].forca;
					excluirTiros.push(tiros[j]);
				}
			}

			for(var i in cenario.pedras){
				if(	pc.danificado <= 0
					&& pc.colidiuComCircular(cenario.pedras[i])){
					pc.danificado = tempoDanificado;
					pc.saude-= danopedra;
				}
			}

			if(pc.saude <=0){
				if(pc.linExplosao >= 4){
					pc.vidas--;
					if(pc.vidas>0)
						pc.restaurar();
					else{
						//TODO GAMEOVER
					}
				}
			}

			for(var i in excluirTiros){
				tiros.splice(tiros.indexOf(excluirTiros[i]),1);
				console.log("Tiro excluido");
			}
			excluirTiros = [];

			for(var i in excluirInimigos){
				inimigos.splice(inimigos.indexOf(excluirInimigos[i]),1);
				console.log("Inimigo excluido");
			}
			excluirInimigos = [];
		}
		
		setInterval(passo, 1000/fps);
		addEventListener("keydown", teclaPressionada);
		addEventListener("keyup", teclaSolta);
		addEventListener("mousemove", atualizaPosicaoMouse, false);
		addEventListener("mousedown", mousePressionado, false);

		audioLib.playBackground("motor");

	</script>
	</body>
</html>